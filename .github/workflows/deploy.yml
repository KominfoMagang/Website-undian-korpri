name: deployment

on:
  push:
    branches:
      - main

jobs:
  cd:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v3

      # 2. Install Node dependencies for Vite build
      - name: Install Node dependencies
        run: |
          npm ci

      # 3. Build Vite production assets
      - name: Build frontend assets
        run: |
          npm run build

      # 4. Upload build folder as artifact
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: public/build

      # 5. Deploy code to server (pull from Git)
      - name: Deploy code to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          passphrase: ""
          script: |
            cd /app/backend

            # Update source code
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # Prepare public/build folder
            rm -rf public/build
            mkdir -p public/build

      # 6. Download compiled assets (public/build) from artifact
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build
          path: public/build

      # 7. Upload built assets to server
      - name: Upload build folder to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "public/build/*"
          target: "/app/backend/public/build"

      # 8. Restart container + run composer + artisan
      - name: Finalize Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          passphrase: ""
          script: |
            cd /app/backend

            # Restart only PHP container (and leave mysql/nginx running)
            docker compose stop asnday
            docker compose up -d asnday

            # Composer + migrations + optimize
            docker exec asnday composer install --no-interaction --prefer-dist --no-dev
            docker exec asnday php artisan migrate --force
            docker exec asnday php artisan optimize

            exit 0
